<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
<mapper namespace="mybatis.mapper.order">
	<resultMap type="order" id="orderVo">
		<result column="order_number" property="order_number"/>
		<result column="member_number" property="member_number"/>
		<result column="order_regdate" property="order_regdate"/>
		<result column="order_price" property="order_price"/>
		<result column="recipient" property="recipient"/>
		<result column="recipient_phone" property="recipient_phone"/>
		<result column="recipient_address" property="recipient_address"/>
		<result column="use_point" property="use_point"/>
		<result column="earn_point" property="earn_point"/>
		<result column="imp_uid" property="imp_uid"/>
		<result column="pay_status" property="pay_status"/>
		<result column="order_status" property="order_status"/>
		<result column="order_join_number" property="order_join_number"/>
		<result column="delivery_cost" property="delivery_cost"/>
	</resultMap>
	
	<select id="selectOrderinfo" resultMap="orderVo" parameterType="long">
		SELECT * FROM m_order WHERE member_number=#{member_number} ORDER BY order_regdate DESC
	</select>
	
	<select id="membershipPoint" resultType="long" parameterType="long">
		SELECT member_point FROM m_member WHERE member_number=#{member_number}
	</select>
	
	<select id="order_join_number" resultType="int" parameterType="String">
		SELECT order_join_number FROM m_order WHERE imp_uid=#{imp_uid}
	</select>
	
	<select id="option_join_number" resultType="int" parameterType="int">
		SELECT MAX(option_join_number) FROM m_order_list WHERE order_join_number=#{order_join_number}
	</select>
	
	<select id="recipient" resultType="String" parameterType="long">
		SELECT member_name FROM m_member WHERE member_number=#{member_number}
	</select>

	<select id="recipient_phone" resultType="String" parameterType="long">
		SELECT member_phone FROM m_member WHERE member_number=#{member_number}
	</select>
	
	<select id="recipient_address" resultType="String" parameterType="long">
		SELECT member_address FROM m_member WHERE member_number=#{member_number}
	</select>
	
	<update id="paymentCancel" parameterType="long">
		update m_cart set cart_status = NULL WHERE member_number=#{member_number}
	</update>
	<update id="productCountUpdate" parameterType="orderSub">
		update m_cart set product_selectcount = #{product_count} WHERE cart_number=#{cart_number}
	</update>
  	<insert id="insertOrder" parameterType="order">
  		INSERT INTO m_order(order_number,member_number,order_regdate,order_price,
  			<if test="#{delivery_cost} != null"> delivery_cost, </if> 
  			<if test="#{recipient} != null"> recipient, </if> 
  			<if test="#{recipient_phone} != null"> recipient_phone, </if> 
  			<if test="#{recipient_address} != null"> recipient_address, </if> 
  			<if test="#{use_point} != null"> use_point, </if> 
  			earn_point,imp_uid,pay_status,order_status,order_join_number
  			)
		VALUES(m_order_seq.nextval,#{member_number},SYSDATE,#{order_price},
			<if test="#{delivery_cost} != null"> #{delivery_cost}, </if> 
			<if test="#{recipient} != null"> #{recipient}, </if> 
			<if test="#{recipient_phone} != null"> #{recipient_phone}, </if> 
			<if test="#{recipient_address} != null"> #{recipient_address}, </if> 
			<if test="#{use_point} != null"> #{use_point}, </if> 
			#{earn_point}, #{imp_uid}, '결제완료', '배송준비중', 
			m_order_join_seq.nextval
			)
  	</insert>
  	
  	<insert id="insertProductList" parameterType="orderSub">
  		INSERT INTO m_order_list(order_list_number,product_number,product_count,option_join_number,order_join_number)
		VALUES(m_order_list_number_seq.nextval,#{product_number},#{product_count},m_option_join_number_seq.nextval,
			#{order_join_number})
  	</insert>
  	
  	<insert id="insertOptionList" parameterType="option">
  		INSERT INTO m_order_option_list(order_option_number,option_number,option_count,option_join_number)
		VALUES(order_option_number.nextval,#{option_number},#{payment_option_count},#{option_Join_Number})
  	</insert>
  	
  	
  	<update id="pointDeduction" parameterType="order">
		update m_member set member_point = member_point-#{use_point} WHERE member_number=#{member_number}
	</update>
  	
  	<delete id="deleteCart" parameterType="int">
		DELETE FROM m_cart WHERE cartoption_number=#{cartoption_number}
	</delete>
	<delete id="deleteCartOption" parameterType="int">
		DELETE FROM m_cartoption WHERE cartoption_number=#{cartoption_number}
	</delete>
	
	<update id="productDeduction" parameterType="orderSub">
		update m_product set product_count = product_count-#{product_count}, product_salcount = product_count+#{product_count} WHERE product_number=#{product_number}
	</update>
	
	<update id="optionDeduction" parameterType="Option">
		update m_option set option_count = option_count-#{option_Count}, option_salcount = option_salcount+#{option_Count} WHERE option_number=#{option_number}
	</update>
	
	
	
	
  
</mapper>
